# 10/12

# [Django] Django 회원가입/로그인📝

## **게시판과 회원가입/로그인 차이점** 💭

- 게시글은 그대로 보여줘도 되지만, 비밀번호는 암호화(해시화)를 해야 함

### Auth💡

- Django authentication system(인증 시스템)은 인증(Authentication)과 권환(Autohrization)부여를 함께 제공하고 있음
- Users
- 권한 및 그룹
- Form 및 View 도구
- 필수 구성은 Settings.py의 INSTALLED_APPS에서 확인 가능
  - django.contrib.auth

### Django Auth 개요💡

- Authentication (인증)
- Authorization (권한, 허가)
  - 권한 부여
  - 인증된 사용자가 수행할 수 있는 작업을 결정

```py
python manage.py startapp accounts

# settings.py
INSTALL_APPS = [
  'articles',
  'accounts',
]
```

### Django User model💡

- Django 공식문서에서 많은 attri를 확인가능.
- https://docs.djangoproject.com/en/4.1/topics/auth/default/

```py
Django는 새 프로젝트를 시작하는 경우 비록 기본 user 모델이 충분하더라도
커스텀 User 모델을 설정하는 것을 "강력하게 권장"

커스텀 User 모델은 기본 User 모델과 동일하게 작동 하면서도
필요한 경우 나중에 맞춤 설정할 수 있기 때문
```

### AUTH_USER_MODEL💡

```py
# setting.py

AUTH_USER_MODEL = 'accounts.User'

# models.py
from django.contrib.auth.models import AbstractUser

class User(AbstractUser):
  pass
```

### User 모델 상속 관계💡

```py
models.Model => class AbstracBaseUser => class AbstractUser => class User
```

## **암호관리** 💭

1. **Django에서는 기본적으로 PBKDF2를 사용하여 저장**

- 단방향 해시함수를 활용하여 비밀번호를 다이제스트로 암호화하며, 이는 복호화가 불가능함

- 단방향 해시함수의 경우 레인보우 공격 및 무차별 대입 공격 등의 문제가 발생 가능함

- 이를 보완하기 위하여 아래의 기법을 추가적으로 활용함
  - 솔팅: 패스워드에 임의의 문자열인 salt를 추가하여 다이제스트를 생성
  - 키 스트레칭: 해시를 여러 번 반복하여 시간을 늘림

2. **비밀번호 생성 및 확인**

```py
User.objects.create_user('hong', 'hong@gmail.com', '1q2w3r')

User.objects.create_user('kim', 'hong@gmail.com','1234')
# 비밀번호 일치 확인 여부
from django.contrib.auth import authenticate

authenticate(username='kim', password='1234')
```

## **회원가입 기능 구현** 💭

```py
# urls.py
from django.urls import path
from . import views

app_name = 'accounts'

urlpatterns = [
    path('signup/', views.signup, name='signup')
  ]

# views.py
from django.shortcuts import render
# from django.contrib.auth.forms import UserCreationForm
from .forms import CustomUserCreationForm

def signup(request):

  if request.method == 'POST':
    # UserCreationForm이 핵심
    form = UserCreationForm(request.POST) # CustomUserCreationForm
      if form.is_valid():
        form.save()
        return redirect( 'articles:index' )
  else:
    form = UserCreationForm() # CustomUserCreationForm
  context = {
    'form': form
  }

  return render(request, 'accounts/signup.html', context)

# forms.py
from django.contrib.auth.forms import UserCreationForm
from .models import User

class CustomUserCreationForm(UserCreationForm):

  class Meta:
    model = User
    # fields = '__all__'
    fields = ('username',)

# admin.py
from django.contrib import admin
from .models import User

admin.site.register(User)
```

### 프로필 페이지를 만든다면?💡

```py
1. URL 설정
2. View
3. Template 반환
```

# ✅ Django 공부

https://docs.djangoproject.com/en/4.1/topics/auth/default/

## **문서 공부** 💭

- Creating users

```py
from django.contrib.auth.models import User
user = User.objects.create_user('john', 'lemmon@thebeatles.com', 'johnpassword')

# if i want to change other fields.
user.last_name = 'Lennon'
user.save()
```

- Creating superusers

```py
# Crate superusers using the createsuperuser command:
python manage.py createsuperuser --usename=emhaki=mhmh779@naver.com
```

- Changing passwordss

```py
from django.contrib.auth.models import User
u = User.objects.get(username='emhaki')
u.set_password('new password')
u.save()
```

- Authenticating users

```py
from django.contrib.auth import authenticate
user = authenticate(username='john', password='secret')
if user is not None:
  # A backend authenticated the credentials
else:
  # No backend authenticated the credentials
```

## **django.contrib.auth** 💭

```py
- User model
  - Fields

- Attributes
  - is_authenticated
  - is_anonymous

- Methods
  - get_username()
  - get_full_name()
  - get_short_name()
  - set_password(raw_password)
  - check_password(raw_password)
  - set_unusable_password()

- Manager methods
  - create_user(username, email=None, password=None, **extra_fields)
  - create_superuser(username, email=None, password=None)
```

## **Customizing authentication in Django** 💭

```py
# Extending the existing User model
from django.contrib.auth.models import User

class Employee(models.Model):
  user = models.OneToOneField(User, on_delete=models.CASCADE)
  department = models.CharField(max_length=100)
```

```py
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from django.contrib.auth.models import User

from my_user_profile_app.models import Employee

class EmployeeInline(admin.StackedInlin):
  model = Employee
  can_delete = False
  verbose_name_plural = 'employee'

class UserAdmin(BaseUserAdmin):
  inlines = (EmployeeInline,)

admin.site.unregister(User)
admin.site.register(User, UserAdmin)
```

## **Password management in Django** 💭

```py
# Django에서의 패스워드 로직
<algorithm>$<iterations>$<salt>$<hash>
```

```py
# Default Password_hashers
PASSWORD_HASHERS = [
    'django.contrib.auth.hashers.PBKDF2PasswordHasher',
    'django.contrib.auth.hashers.PBKDF2SHA1PasswordHasher',
    'django.contrib.auth.hashers.Argon2PasswordHasher',
    'django.contrib.auth.hashers.BCryptSHA256PasswordHasher',
]
```

## **Django CRUD 과정** 💭

1. 가상환경 생성 및 실행

```py
python -m venv venv
source venv/Scripts/activate
```

- Django 설치 및 기록

```py
pip install django==3.2.13
pip freeze > requirements.txt
```

- Django 프로젝트 생성

```py
django-admin startproject pjt .
```

2. articles app 생성

```py
python manage.py startapp app_name

# settings.py 파일의 INSTALLED_APPS에 추가
INSTALLED_APPS = [
  'articles,
  ...
]

# urls.py 설정
urlpattens = [
  ...
  path('articles/', include('articles.urls'))
]

# articles/urls.py
from django.urls import path
from . import views

app_name = 'articles'

urlpatterns = [
  path('', views.index, name='index'),
  ...
]

{% url '앱네임:(path name)index'%}
```

3. Model 정의 (DB 설계)

- 클래스 정의

```py
class Article(models.Model):
  title = models.CharField(max_length=20)
  content = models.TextField()
  created_at = models.DateTimeField(auto_now_add=True)
  updated_at = models.DateTimeField(auto_now=Ture)
```

- 마이그레이션 파일 생성

```py
python manage.py makemigrations
```

- DB반영(migrate)

```py
python manage.py migrate
```

4. CRUD 기능 구현

- ModelForm 선언

```py
from django import forms
from .models import Article

class ArticleForm(forms.ModelForm):

  class Meta:
    model = Article
    fields = ['title', 'content']
```

- 게시글 생성

```py
# views.py

def create(request):
  article_form = ArticleForm()
  context = {
    'article_form': article_form
  }
  return render(request, 'articles/create.html', context=context)

#create.html
<h1>글쓰기</h1>
<form action="" method="POST">
  {% csrf_token %}
  {{ article_form.as_p }}
  <input type="submit" value="글쓰기">
</form>
```

```py
# 변경
def create(request):
  if request.method == 'POST':
    article_form = ArticleForm(request.POST)
    if article_form.is_valid()
      article_form.save()
      return redirect('articles:index')
  else:
    article_form = ArticleForm()
  context = {
    'article_form': article_form
  }
  return render(request, 'articles/new.html', context=context)
```
